---
tags:
  - docker
---
# Docker

## Основные компоненты Docker

1. **Docker Daemon (демон):** основной процесс, управляющий контейнерами.
2. **Docker CLI (интерфейс командной строки):** позволяет взаимодействовать с демоном.
3. **Docker API:** интерфейс взаимодействия между CLI и демоном.
4. **Docker Image (образ):** шаблон для создания контейнеров.
5. **Docker Container (контейнер):** запущенный экземпляр образа.
6. **Docker Registry (реестр):** хранилище образов (например, Docker Hub).
7. **Docker Volume (том):** механизм хранения данных контейнеров.
8. **Docker Network (сеть):** виртуальная сеть для взаимодействия контейнеров.

### Архитектура Docker

```
+--------------------+         +--------------------------+
| Docker CLI         |         | Docker Daemon            |
| (docker run)       |         | (dockerd)                |
+--------------------+         +--------------------------+
         |                              |
         v                              v
+--------------------+         +--------------------------+
| Docker API         |         | Containerd               |
+--------------------+         | (Управление контейнерами)|
	                           +--------------------------+
                                          |
                                          v
                             +----------------------------+
                             | runc                       |
                             | (Создание контейнеров)     |
                             +----------------------------+
```

## Основные параметры Docker Daemon

```json
{
  "log-level": "info",
  "storage-driver": "overlay2",
  "data-root": "/var/lib/docker",
  "insecure-registries": ["myregistry.local:5000"],
  "registry-mirrors": ["https://mirror.gcr.io"],
  "dns": ["8.8.8.8", "8.8.4.4"],
  "experimental": true,
  "max-concurrent-downloads": 3,
  "live-restore": true
}
```

#### Описание основных параметров
| **Параметр**                 | **Описание**                                                      | **Пример значения**                     |
| ---------------------------- | ----------------------------------------------------------------- | --------------------------------------- |
| **log-level**                | Уровень логирования (debug, info, warn, error, fatal)             | "info"                                  |
| **storage-driver**           | Драйвер хранения данных контейнеров                               | "overlay2"                              |
| **data-root**                | Директория для хранения данных Docker                             | "/var/lib/docker"                       |
| **insecure-registries**      | Небезопасные (HTTP) реестры Docker                                | ["myregistry.local:5000"]               |
| **registry-mirrors**         | Зеркала Docker Hub для ускорения загрузки образов                 | ["https://mirror.gcr.io"]               |
| **dns**                      | Настройки DNS-серверов для контейнеров                            | ["8.8.8.8", "8.8.4.4"]                  |
| **max-concurrent-downloads** | Максимальное количество одновременных загрузок                    | 3                                       |
| **max-concurrent-uploads**   | Максимальное количество одновременных загрузок образов            | 5                                       |
| **live-restore**             | Обеспечивает сохранение контейнеров при перезапуске Docker Daemon | true                                    |
| **iptables**                 | Управление настройками iptables через Docker                      | true                                    |
| **bridge**                   | Настройка моста Docker                                            | "docker0"                               |
| **mtu**                      | Установка MTU для сети Docker                                     | 1500                                    |
| **bip**                      | Настройка IP-пула для мостовой сети                               | "192.168.1.1/24"                        |
| **no-new-privileges**        | Отключение повышения привилегий в контейнере                      | true                                    |
| **exec-opts**                | Опции выполнения контейнеров (например, настройки runc)           | ["native.cgroupdriver=systemd"]         |
| **default-address-pools**    | Настройка диапазонов IP-адресов для создания сетей                | [{"base": "172.80.0.0/16", "size": 24}] |
| **experimental**             | Включение экспериментальных функций Docker                        | true                                    |

## Пространства имен (namespaces) в ядре Linux

1. **PID (Process ID namespace)**
	- Изолирует процессы, позволяя контейнеру иметь собственное дерево процессов.
	- Внутри контейнера процессы имеют PID, начиная с 1 (аналогично init-процессу в системе).
	- Контейнеры не видят процессы друг друга.
```bash
# внутри контейнера 
ps -aux

# на хосте
ps -e --forest
```

2. **NET (Network namespace)**
	-  Изолирует сетевые интерфейсы, IP-адреса, маршруты и брандмауэры.
	-  Каждый контейнер имеет собственный сетевой стек.
	-  Поддерживаются виртуальные интерфейсы (veth), мосты (bridge) и оверлейные сети.
```bash
ip addr
```

3. **IPC (Inter-Process Communication namespace)**
	- Изолирует механизмы межпроцессного взаимодействия: очереди сообщений, разделяемую память (SHM) и семафоры.
	- Обеспечивает безопасность данных при использовании общего хранилища между процессами.
```bash
# покажет сколько ресурсов доступно внетри контейнера
ipcs -m
```

4. **MNT (Mount namespace)**
- Изолирует файловую систему (точки монтирования).
- Контейнеры имеют собственное корневое файловое дерево.
- Изменения внутри контейнера не влияют на файловую систему хоста.
```bash
# посмотреть точки монтирования в контейнере
mount | grep overlay
```

5. **UTS (Unix Time-Sharing namespace)**
- Изолирует информацию о хосте, включая имя узла (hostname) и доменное имя (NIS).
- Контейнеры могут иметь свои собственные имена.
```bash
hostnamectl set-hostname mycontainer
```

6. **USER (User namespace)**
- Изолирует учетные записи пользователей и идентификаторы (UID и GID).
- Позволяет запускать процессы с привилегиями root внутри контейнера, но без прав root на хосте.
- Улучшает безопасность, сопоставляя привилегированные процессы с непривилегированными на хосте.
```bash
dockerd --userns-remap=default
```

7. **CGROUP (Control Groups namespace)**
- Изолирует и ограничивает ресурсы контейнера (CPU, память, дисковое пространство).
- Используется для контроля потребления ресурсов и предотвращения “захвата” всей мощности хоста.
```bash
docker run -m 512m nginx
```

### Проверка пространств имен на хосте

Увидеть пространства имен контейнера
```bash
lsns
```

Посмотреть PID namespace конкретного контейнера
```bash
docker inspect -f '{{.State.Pid}}' mycontainer
```

## Сеть

### Основные сетевые драйверы Docker

| **Драйвер** | **Описание**                                                                | **Использование**                                                                               |
| ----------- | --------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| bridge      | Создаёт виртуальный мост между контейнерами на одном хосте                  | Изоляции контейнеров на одном хосте                                                             |
| host        | Использует сетевой стек хоста без изоляции                                  | Высокая производительность при отсутствии изоляции                                              |
| none        | Не создаёт сетевого интерфейса                                              | Полная изоляция от сети                                                                         |
| overlay     | Соединяет контейнеры между разными хостами через виртуальную сеть           | Для объединения контейнеров на разных узлах. Используется в кластерах Docker Swarm и Kubernetes |
| macvlan     | Прямое подключение контейнера к физической сети через виртуальный MAC-адрес | Прямой доступ к внешней сети                                                                    |
| ipvlan      | Похож на macvlan, но использует IP-адреса вместо MAC-адресов                | Подходит для сетей с ограничением на количество MAC                                             |
| custom      | Пользовательские плагины через API                                          | Расширенные настройки и интеграции                                                              |
#### Bridge-сеть (по умолчанию)

Bridge — основная сеть Docker, создаваемая по умолчанию.
- Драйвер: bridge
- Интерфейс: docker0
- Адрес по умолчанию: 172.17.0.0/16

```bash
# Проверка bridge-сети
docker network ls
docker network inspect bridge

# Создание контейнера в bridge-сети
docker run -d --name web --network bridge nginx

# Проверка сетевого подключения
docker exec -it web ping google.com
```

#### Host-сеть

Контейнер использует сетевой стек хостовой машины.
- Нет изоляции на уровне сети.
- Высокая производительность, так как не используется NAT.
- Полезно для приложений с низкой задержкой (например, сервисы с большим трафиком).

```bash
# Запуск контейнера с host-сетью
docker run -d --name web --network host nginx

# Порт 80 контейнера будет доступен напрямую через IP хоста
curl http://localhost
```

#### None-сеть

Контейнер не подключается к сети вообще.
- Полная изоляция от внешней сети.
- Полезно для выполнения изолированных задач (например, расчётов).

```bash
docker run -d --name isolated --network none alpine sleep 1000
```

#### Overlay-сеть

Позволяет соединять контейнеры между разными узлами в кластере.
- Используется в Docker Swarm и Kubernetes.
- Требует настройки ключей шифрования (если включено).

```bash
# Создание сети
docker network create -d overlay my_overlay

# Запуск контейнера
docker service create --name web --network my_overlay nginx
```

#### Macvlan-сеть

Контейнер получает собственный MAC-адрес и IP-адрес из локальной сети.
- Контейнеры могут напрямую взаимодействовать с внешними устройствами.
- Подходит для систем с требованиями к прямому подключению.

```bash
# Создание сети
docker network create -d macvlan \
  --subnet=192.168.1.0/24 \
  --gateway=192.168.1.1 \
  -o parent=eth0 macvlan_net

# Запуск контейнера
docker run -d --name macvlan_cont --network macvlan_net nginx
```

#### Создание пользовательской сети

Docker позволяет создавать свои сети с заданными параметрами.

```bash
# Пример создания
docker network create --driver bridge \
  --subnet 192.168.10.0/24 \
  custom_bridge

# Запуск контейнера в пользовательской сети
docker run -d --name custom_web --network custom_bridge nginx
```

#### Проверка сетевых интерфейсов на контейнере

После создания контейнера можно проверить его сетевые интерфейсы:
```bash
docker exec -it custom_web ip addr

# Проверка маршрутов
docker exec -it custom_web ip route
```


## Docker: Работа с томами (Volumes)

Тома (Volumes) в Docker используются для хранения данных контейнеров вне самого контейнера. Это позволяет сохранять данные при пересоздании контейнеров и организовывать совместное использование данных между ними.

1. **Персистентность данных** — данные не теряются при пересоздании контейнеров.
2. **Совместное использование** — несколько контейнеров могут одновременно работать с одним томом.
3. **Производительность** — тома быстрее, чем монтирование хостовой директории.
4. **Безопасность** — тома изолированы от файловой системы хоста.
5. **Управляемость** — простое создание, монтирование и удаление.

### Типы томов в Docker

| **Тип**          | **Описание**                                                                       | **Когда использовать**                                    |
| ---------------- | ---------------------------------------------------------------------------------- | --------------------------------------------------------- |
| Volume           | Управляемый Docker том, находящийся в /var/lib/docker/volumes/.                    | Для изоляции данных от хоста, безопасного хранения данных |
| Bind mount       | Прямое монтирование папки с хоста в контейнер.                                     | Для доступа к хостовым данным из контейнера               |
| tmpfs            | Том в оперативной памяти, данные не сохраняются на диск.                           | Для временных данных, кэшей                               |
| Named Volume     | Именованный том, который можно легко идентифицировать.                             | Для удобного управления постоянными данными               |
| Anonymous Volume | Том без имени, создается автоматически при запуске контейнера без явного указания. | Для временного хранения данных                            |

## Docker Buildx — создание кроссплатформенных образов

Docker Buildx позволяет создавать образы для нескольких архитектур в рамках одного процесса.

### Настройка Buildx

Создайте новую сборочную среду:
```bash
docker buildx create --use --name multiarch-builder
docker buildx inspect --bootstrap
```

Пример Dockerfile:
```bash
FROM --platform=$BUILDPLATFORM alpine:3.18

# Переменные окружения
ARG TARGETARCH
RUN echo "Building for architecture: $TARGETARCH" > /arch.txt

CMD cat /arch.txt
```

Команда сборки образа:
```bash
docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7 -t myimage:multiarch --push .
```

- --platform — перечисляем целевые архитектуры.
- --push — отправка в реестр (например, Docker Hub).
- -t — тег образа.
- . — путь к Dockerfile.


