# VirtualService
#virtualService

VirtualService —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Ö–æ–¥—è—â–∏–º —Ç—Ä–∞—Ñ–∏–∫–æ–º –∏ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç **URI, –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –≤–µ—Å–∞ –∏ –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**.

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è VirtualService

| **–ü–æ–ª–µ**         | **–û–ø–∏—Å–∞–Ω–∏–µ**                                                                     |
| ---------------- | -------------------------------------------------------------------------------- |
| hosts            | –ö –∫–∞–∫–æ–º—É —Å–µ—Ä–≤–∏—Å—É –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è                                                     |
| gateways         | –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ **Istio Gateway** (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –∑–Ω–∞—á–∏—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è) |
| http / tcp / tls | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏                                                 |
| route            | –°–ø–∏—Å–æ–∫ Destination, –∫—É–¥–∞ –ø–æ–π–¥–µ—Ç —Ç—Ä–∞—Ñ–∏–∫                                           |
| match            | –£—Å–ª–æ–≤–∏—è (–∑–∞–≥–æ–ª–æ–≤–∫–∏, –ø—É—Ç–∏, –º–µ—Ç–æ–¥—ã –∏ —Ç. –¥.)                                        |
## –ü—Ä–∏–º–µ—Ä VirtualService (–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ –≤–µ—Ä—Å–∏—è–º)

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-app
spec:
  hosts:
    - my-app.default.svc.cluster.local  # –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —Å–µ—Ä–≤–∏—Å—É my-app
  http:
    - match:
        - headers:
            user-agent:
              regex: ".*Chrome.*"  # –¢—Ä–∞—Ñ–∏–∫ –æ—Ç Chrome –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –≤ v2
      route:
        - destination:
            host: my-app.default.svc.cluster.local
            subset: v2
    - route:  
        - destination:
            host: my-app.default.svc.cluster.local
            subset: v1  # –û—Å—Ç–∞–ª—å–Ω–æ–π —Ç—Ä–∞—Ñ–∏–∫ –∏–¥–µ—Ç –≤ v1
```

## VirtualService ‚Äî –ü–æ–ª—è –∏ –æ–ø–∏—Å–∞–Ω–∏–µ

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è VirtualService
| **–ü–æ–ª–µ** | **–¢–∏–ø**     | **–û–ø–∏—Å–∞–Ω–∏–µ**                                                               |
| -------- | ----------- | -------------------------------------------------------------------------- |
| hosts    | []string    | **–°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤**, –∫ –∫–æ—Ç–æ—Ä—ã–º –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è VirtualService                  |
| gateways | []string    | **–°–ø–∏—Å–æ–∫ Istio Gateway**, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å —Ç—Ä–∞—Ñ–∏–∫            |
| http     | []HTTPRoute | **–ü—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ HTTP**                                             |
| tcp      | []TCPRoute  | **–ü—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ TCP**                                              |
| tls      | []TLSRoute  | **–ü—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ TLS**                                              |
| exportTo | []string    | **–ì–¥–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VirtualService** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é *, —Ç.–µ. –≥–ª–æ–±–∞–ª—å–Ω–æ) |

### –ü–æ–ª—è http (HTTPRoute)
| **–ü–æ–ª–µ**   | **–¢–∏–ø**                | **–û–ø–∏—Å–∞–Ω–∏–µ**                                                |
| ---------- | ---------------------- | ----------------------------------------------------------- |
| match      | []HTTPMatchRequest     | **–§–∏–ª—å—Ç—Ä –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** (–ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º, –º–µ—Ç–æ–¥–∞–º, –ø—É—Ç–∏) |
| route      | []HTTPRouteDestination | **–ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã**                                 |
| redirect   | HTTPRedirect           | **–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ HTTP (301/302)**                          |
| rewrite    | HTTPRewrite            | **–ò–∑–º–µ–Ω–µ–Ω–∏–µ URL –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–∞ –±—ç–∫–µ–Ω–¥**                 |
| timeout    | Duration               | **–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5s)                          |
| retries    | HTTPRetry              | **–ü–æ–ª–∏—Ç–∏–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫**                              |
| fault      | HTTPFaultInjection     | **–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—à–∏–±–æ–∫**                           |
| corsPolicy | CORSPolicy             | **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ CORS**                                          |
### –ü–æ–ª—è match (HTTPMatchRequest)
| **–ü–æ–ª–µ**    | **–¢–∏–ø**                | **–û–ø–∏—Å–∞–Ω–∏–µ**                                |
| ----------- | ---------------------- | ------------------------------------------- |
| uri         | StringMatch            | **–§–∏–ª—å—Ç—Ä –ø–æ –ø—É—Ç–∏ (regex, prefix, exact)**   |
| method      | StringMatch            | **–§–∏–ª—å—Ç—Ä –ø–æ HTTP-–º–µ—Ç–æ–¥—É (GET, POST, etc.)** |
| headers     | map[string]StringMatch | **–§–∏–ª—å—Ç—Ä –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º**                    |
| queryParams | map[string]StringMatch | **–§–∏–ª—å—Ç—Ä –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º URL**                |
#### –ü—Ä–∏–º–µ—Ä —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –∏ –º–µ—Ç–æ–¥—É
```yaml
match:
  - headers:
      user-agent:
        regex: ".*Firefox.*"
    method:
      exact: GET
```

### –ü–æ–ª—è route (HTTPRouteDestination)
| **–ü–æ–ª–µ**    | **–¢–∏–ø**     | **–û–ø–∏—Å–∞–Ω–∏–µ**                                   |
| ----------- | ----------- | ---------------------------------------------- |
| destination | Destination | **–ö–æ–Ω–µ—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å** (–∫—É–¥–∞ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç—Ä–∞—Ñ–∏–∫) |
| weight      | int         | **–í–µ—Å (–≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö) –ø—Ä–∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–µ**         |
#### –ü—Ä–∏–º–µ—Ä –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ 80% —Ç—Ä–∞—Ñ–∏–∫–∞ –≤ v1, 20% ‚Äî –≤ v2
```yaml
route:
  - destination:
      host: my-app.default.svc.cluster.local
      subset: v1
    weight: 80
  - destination:
      host: my-app.default.svc.cluster.local
      subset: v2
    weight: 20
```

# DestinationRule ‚Äî –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∏ –ø–æ–ª–∏—Ç–∏–∫–∏
#DestinationRule

–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ VirtualService –Ω–∞–ø—Ä–∞–≤–∏–ª —Ç—Ä–∞—Ñ–∏–∫, **DestinationRule** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–¥–æ–≤.

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è DestinationRule
| **–ü–æ–ª–µ**      | **–û–ø–∏—Å–∞–Ω–∏–µ**                            |
| ------------- | --------------------------------------- |
| host          | –ö –∫–∞–∫–æ–º—É —Å–µ—Ä–≤–∏—Å—É –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è            |
| subsets       | –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–µ—Ä—Å–∏–∏ (–ø–æ labels)           |
| trafficPolicy | –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞, —Ç–∞–π–º–∞—É—Ç—ã, –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–µ—Å—Å–∏–∏ |
## –ü—Ä–∏–º–µ—Ä DestinationRule (–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –æ—Ç–∫–∞–∑–∞)

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: my-app
spec:
  host: my-app.default.svc.cluster.local
  subsets:
    - name: v1
      labels:
        version: v1
    - name: v2
      labels:
        version: v2
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN  # –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ –∫—Ä—É–≥—É
    connectionPool:
      http:
        http1MaxPendingRequests: 10
        maxRequestsPerConnection: 1
    outlierDetection:
      consecutiveErrors: 5
      interval: 10s
      baseEjectionTime: 30s
```
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç **v1 –∏ v2** –∫–∞–∫ —Ä–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- **–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ ROUND_ROBIN** –º–µ–∂–¥—É –ø–æ–¥–∞–º–∏.
- **–õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤** –∏ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏.
- **Outlier Detection** (–µ—Å–ª–∏ –ø–æ–¥ –ø–∞–¥–∞–µ—Ç 5 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ ‚Äî –µ–≥–æ –∏—Å–∫–ª—é—á–∞—é—Ç).

## DestinationRule ‚Äî –ü–æ–ª—è –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è DestinationRule
| **–ü–æ–ª–µ**      | **–¢–∏–ø**       | **–û–ø–∏—Å–∞–Ω–∏–µ**                                                         |
| ------------- | ------------- | -------------------------------------------------------------------- |
| host          | string        | **–°–µ—Ä–≤–∏—Å, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª–æ**                           |
| subsets       | []Subset      | **–í–µ—Ä—Å–∏–∏ —Å–µ—Ä–≤–∏—Å–∞ (–ø–æ label‚Äô–∞–º)**                                     |
| trafficPolicy | TrafficPolicy | **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏, –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** |
### –ü–æ–ª—è subsets (Subset)
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç **–≤–µ—Ä—Å–∏–∏ —Å–µ—Ä–≤–∏—Å–∞**, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.

| **–ü–æ–ª–µ**      | **–¢–∏–ø**           | **–û–ø–∏—Å–∞–Ω–∏–µ**                       |
| ------------- | ----------------- | ---------------------------------- |
| name          | string            | **–ù–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, v1) |
| labels        | map[string]string | **–ú–µ—Ç–∫–∞ (label) –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–¥–æ–≤** |
| trafficPolicy | TrafficPolicy     | **–°–≤–æ–∏ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏**   |
#### –ü—Ä–∏–º–µ—Ä –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ v1 –∏ v2
```yaml
subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```
### –ü–æ–ª—è trafficPolicy (TrafficPolicy)
| **–ü–æ–ª–µ**         | **–¢–∏–ø**                | **–û–ø–∏—Å–∞–Ω–∏–µ**                        |
| ---------------- | ---------------------- | ----------------------------------- |
| loadBalancer     | LoadBalancerSettings   | **–°—Ç—Ä–∞—Ç–µ–≥–∏—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏**          |
| connectionPool   | ConnectionPoolSettings | **–õ–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** |
| outlierDetection | OutlierDetection       | **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞–¥–µ–Ω–∏—è –ø–æ–¥–æ–≤**         |
### –ü–æ–ª—è loadBalancer (LoadBalancerSettings)
| **–ó–Ω–∞—á–µ–Ω–∏–µ** | **–û–ø–∏—Å–∞–Ω–∏–µ**                             |
| ------------ | ---------------------------------------- |
| ROUND_ROBIN  | **–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ –∫—Ä—É–≥—É** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| LEAST_CONN   | **–ù–∞–∏–º–µ–Ω—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**     |
| RANDOM       | **–°–ª—É—á–∞–π–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**              |
| PASSTHROUGH  | **–ë–µ–∑ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏, –Ω–∞–ø—Ä—è–º—É—é –≤ –ø–æ–¥**     |
#### –ü—Ä–∏–º–µ—Ä –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –ø–æ –Ω–∞–∏–º–µ–Ω—å—à–µ–º—É —á–∏—Å–ª—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
```yaml
trafficPolicy:
  loadBalancer:
    simple: LEAST_CONN
```

### –ü–æ–ª—è connectionPool (ConnectionPoolSettings)
| **–ü–æ–ª–µ**                 | **–û–ø–∏—Å–∞–Ω–∏–µ**                        |
| ------------------------ | ----------------------------------- |
| http1MaxPendingRequests  | **–ú–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏**     |
| maxRequestsPerConnection | **–ú–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ** |
```yaml
connectionPool:
  http:
    http1MaxPendingRequests: 10
    maxRequestsPerConnection: 1
```

### –ü–æ–ª—è outlierDetection (OutlierDetection)
| **–ü–æ–ª–µ**          | **–û–ø–∏—Å–∞–Ω–∏–µ**                                    |
| ----------------- | ----------------------------------------------- |
| consecutiveErrors | **–°–∫–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥ —Å—á–∏—Ç–∞–µ—Ç—Å—è ‚Äú–ø—Ä–æ–±–ª–µ–º–æ–π‚Äù** |
| interval          | **–ö–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥—ã**                    |
| baseEjectionTime  | **–ö–∞–∫ –¥–æ–ª–≥–æ –∏—Å–∫–ª—é—á–∞—Ç—å –ø–æ–¥**                     |
#### –ü—Ä–∏–º–µ—Ä –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–æ–≤ –ø–æ—Å–ª–µ 5 –æ—à–∏–±–æ–∫
```yaml
outlierDetection:
  consecutiveErrors: 5
  interval: 10s
  baseEjectionTime: 30s
```

# –ö–∞–∫ VirtualService –∏ DestinationRule —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ

1. **VirtualService** –≤—ã–±–∏—Ä–∞–µ—Ç, **–∫—É–¥–∞** –Ω–∞–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ (–ø–æ subset).
2. **DestinationRule** —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º —Ç—Ä–∞—Ñ–∏–∫–∞ –≤–Ω—É—Ç—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.

**–ü—Ä–∏–º–µ—Ä —Å—Ö–µ–º—ã:**
```
Client ‚Üí VirtualService (–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è) ‚Üí DestinationRule (–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞)
```

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –≤ Istio

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫ Istio –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞—Ñ–∏–∫:
```bash
kubectl get virtualservice,destinationrule
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã –≤ Istio:
```bash
istioctl proxy-config routes $(kubectl get pod -l app=my-app -o jsonpath='{.items[0].metadata.name}') -o json
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É:
```bash
for i in {1..10}; do curl -s http://my-app.default.svc.cluster.local; done
```










–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø—Ä–æ–±–æ–≤–∞—Ç—å **–∫–∞–Ω–∞—Ä–µ–π–∫—É, A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ fault injection!** üî•