---
tags:
  - promql
---

# PromQL — Язык запросов в Prometheus

## Типы метрик в Prometheus

- **Counter (счетчик)** – монотонно увеличивается, например http_requests_total.
- **Gauge (измеритель)** – изменяется в обе стороны, например memory_usage_bytes.
- **Histogram (гистограмма)** – собирает значения в баках (buckets), например http_request_duration_seconds_bucket.
- **Summary (сводка)** – похож на Histogram, но включает квантильные значения.

## Базовые запросы в PromQL

```promql
http_requests_total
```
Вернет все временные ряды с этой метрикой.

```promql
http_requests_total{job="nginx", status="200"}
```
Выберет только успешные (status="200") запросы для nginx.

## Функции и операции в PromQL

### Арифметические операции

```promql
rate(http_requests_total[5m]) * 100
```
Это запрос скорости запросов за 5 минут, умноженный на 100.

### Агрегация

```promql
avg(rate(http_requests_total[5m]))
```
Посчитаем среднее количество запросов по всем инстансам.

Другие агрегирующие функции:
- sum() – сумма
- min() – минимум
- max() – максимум
- count() – количество временных рядов
- topk(n, ...) – топ n значений

```promql
topk(5, rate(http_requests_total[5m]))
```
Выведет топ-5 сервисов по количеству запросов.

## Работа со временем

```promql
http_requests_total offset 1h
```
Вернет значение метрики час назад.

```promql
rate(http_requests_total[5m]) - rate(http_requests_total[1h])
```
Разница между средней скоростью запросов за 5 минут и за час.

## Группировка данных

```promql
sum(rate(http_requests_total[5m])) by (status)
```
Посчитаем количество запросов, сгруппировав по HTTP-кодам.

## Разница между rate() и irate() в PromQL

Обе функции используются для расчета скорости изменения **счетчиков (Counter)**, но у них разные подходы:

### rate() — средняя скорость за интервал

Функция rate() вычисляет **среднюю** скорость изменения метрики за заданный временной интервал.
```promql
rate(http_requests_total[5m])
```
Это покажет **среднюю скорость** запросов за последние 5 минут.

- Подходит для анализа трендов.
- Используется в дашбордах и алертах.
- Хорош для данных с шумом (всплесками).

### irate() — мгновенная скорость

Функция irate() берет **только два последних значения** в заданном временном окне и рассчитывает скорость изменения между ними.
```promql
irate(http_requests_total[5m])
```
Это покажет **мгновенную скорость** запросов за последние 5 минут.

- Подходит для отображения **моментальных изменений**.
- Лучше для графиков с высокой частотой обновления.
- Может давать более шумные результаты.

### Пример разницы

Допустим, у нас есть метрика http_requests_total, и данные выглядят так (значения увеличиваются):

| **Время** | **Значение** http_requests_total |
| --------- | -------------------------------- |
| 12:00     | 1000                             |
| 12:01     | 1020                             |
| 12:02     | 1050                             |
| 12:03     | 1100                             |
| 12:04     | 1200                             |
- **rate(http_requests_total[5m])**
	- Возьмет все точки за 5 минут, усреднит разницу → (1200 - 1000) / 5 = **40 req/sec**
- **irate(http_requests_total[5m])**
	- Возьмет только последние две точки (1200 и 1100) → (1200 - 1100) / 1 = **100 req/sec**

### Когда что использовать?

| **Функция** | **Использовать для**                       |
| ----------- | ------------------------------------------ |
| rate()      | Общая тенденция, графики, алерты           |
| irate()     | Мгновенные всплески, детальная диагностика |
Если строишь **графики трендов** — используй rate().
Если хочешь **поймать резкие скачки** — используй irate().

## Полезные функции в PromQL

### Функции агрегации
Эти функции помогают суммировать, усреднять или группировать данные.

#### sum() — суммирование значений

Подсчитаем общее количество HTTP-запросов во всей системе:
```promql
sum(rate(http_requests_total[5m]))
```
Полезно для расчета нагрузки на сервис.
#### avg() — среднее значение

Средняя нагрузка на CPU среди всех подов:
```promql
avg(rate(container_cpu_usage_seconds_total[5m]))
```
Хорошо подходит для оценки общей загруженности.

#### max() и min() — максимум и минимум

Максимальная скорость запросов среди всех инстансов:
```promql
max(rate(http_requests_total[5m])) by (instance)
```

Минимальное использование памяти среди всех подов:
```promql
min(container_memory_usage_bytes)
```

Позволяет находить “узкие места” в системе.

#### count() — количество временных рядов

Сколько подов сейчас отправляют метрики о потреблении CPU:
```promql
count(container_cpu_usage_seconds_total)
```
Используется для оценки количества активных объектов (поды, инстансы и т. д.).

### Функции изменения временных рядов

#### rate() — средняя скорость изменения

Средняя скорость входящих HTTP-запросов за 5 минут:
```promql
rate(http_requests_total[5m])
```
Используется для метрик типа Counter.
#### irate() — мгновенная скорость изменения

Мгновенная скорость запросов за последние 5 минут:
```yaml
irate(http_requests_total[5m])
```
Полезно для отображения быстрых скачков нагрузки.
#### increase() — общее изменение метрики за период

Общее количество запросов, пришедших за 1 час:
```promql
increase(http_requests_total[1h])
```
Полезно для подсчета общего количества событий за определенное время.

### Функции работы со временем

#### time() — текущее время в секундах

Покажет текущее время (Unix timestamp):
```promql
time()
```
Можно использовать для расчета задержек.
#### timestamp() — временная метка метрики

Вернет timestamp последнего обновления метрики:
```promql
timestamp(http_requests_total)
```
Полезно для отладки.

### Функции работы с лейблами

#### label_replace() — замена значений в лейблах

Заменим job="nginx" на job="web-server":
```promql
label_replace(http_requests_total, "job", "web-server", "job", "nginx")
```
Удобно для нормализации данных.
#### label_join() — объединение значений лейблов

Объединим namespace и pod в один лейбл full_name:
```promql
label_join(container_cpu_usage_seconds_total, "full_name", "-", "namespace", "pod")
```
Полезно, когда нужно создать уникальный идентификатор.

### Функции изменения масштаба данных

#### rate() vs deriv()

- rate() вычисляет **среднюю** скорость роста счетчика.
- deriv() вычисляет **моментальную производную**.

```promql
deriv(node_cpu_seconds_total[5m])
```
Подходит для предсказания трендов.

#### histogram_quantile() — квантили для гистограмм

90-й перцентиль времени ответа HTTP-запросов:
```promql
histogram_quantile(0.9, rate(http_request_duration_seconds_bucket[5m]))
```
Полезно для измерения задержек.

### Вывод
- Если нужно **агрегировать** данные → sum(), avg(), max(), count().
- Если нужно **измерить скорость изменения** → rate(), irate(), increase().
- Если нужно **обрабатывать лейблы** → label_replace(), label_join().
- Если нужно **анализировать время ответа** → histogram_quantile().

## Разница между квантилем и персентилем

Оба понятия используются в статистике для описания распределения данных, но есть небольшая разница:

|**Параметр**|**Квантиль (Quantile)**|**Персентиль (Percentile)**|
|---|---|---|
|**Определение**|Точка, которая делит данные на равные части.|Частный случай квантили, делит данные на 100 частей.|
|**Пример**|Медиана (0.5-квантиль) делит данные на 2 равные части.|95-й персентиль означает, что 95% значений меньше данной точки.|
|**Формат записи**|q (доли, от 0 до 1)|p (проценты, от 0 до 100)|
### Квантиль (Quantile)

Квантиль — это значение, которое делит набор данных на определенные **равные части**.

Примеры квантилей:
- Медиана (0.5-квантиль) — середина данных.
- Квартиль (0.25, 0.5, 0.75) — делит на 4 части.
- Дециль (0.1, 0.2, …, 0.9) — делит на 10 частей.

Пример:

Допустим, у нас есть данные о времени ответа HTTP-запросов:
```
[100ms, 150ms, 200ms, 250ms, 300ms, 350ms, 400ms]
```
- 0.5-квантиль (медиана) → **250ms**
- 0.25-квантиль (первый квартиль) → **175ms**
- 0.75-квантиль (третий квартиль) → **325ms**
### Персентиль (Percentile)

Персентиль — это частный случай квантили, делящий данные на **100 частей**.

Примеры персентилей:
- **50-й персентиль = 0.5-квантиль = медиана**.
- **90-й персентиль** — 90% значений меньше этого порога.
- **99-й персентиль** — 99% значений меньше этого порога.

**Пример:**
Возьмем те же данные 
```
[100ms, 150ms, 200ms, 250ms, 300ms, 350ms, 400ms].
```
- **90-й персентиль** (примерно 90% запросов быстрее него) → **370ms**
- **99-й персентиль** (99% запросов быстрее него) → **395ms**
### Использование в Prometheus

В Prometheus есть функция:
```promql
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
```
- 0.95 — **95-й персентиль** (эквивалент 0.95-квантили).
- http_request_duration_seconds_bucket — гистограмма с распределением задержек.

### Вывод:
- **Квантили** делят данные на **равные доли**.
- **Персентили** — частный случай квантилей, делят на **100 частей**.
- В PromQL мы используем histogram_quantile(0.95, ...) для анализа задержек.