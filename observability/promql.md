---
tags:
  - promql
---

# PromQL — Язык запросов в Prometheus

## Типы метрик в Prometheus

- **Counter (счетчик)** – монотонно увеличивается, например http_requests_total.
- **Gauge (измеритель)** – изменяется в обе стороны, например memory_usage_bytes.
- **Histogram (гистограмма)** – собирает значения в баках (buckets), например http_request_duration_seconds_bucket.
- **Summary (сводка)** – похож на Histogram, но включает квантильные значения.

## Базовые запросы в PromQL

```promql
http_requests_total
```
Вернет все временные ряды с этой метрикой.

```promql
http_requests_total{job="nginx", status="200"}
```
Выберет только успешные (status="200") запросы для nginx.

## Функции и операции в PromQL

### Арифметические операции

```promql
rate(http_requests_total[5m]) * 100
```
Это запрос скорости запросов за 5 минут, умноженный на 100.

### Агрегация

```promql
avg(rate(http_requests_total[5m]))
```
Посчитаем среднее количество запросов по всем инстансам.

Другие агрегирующие функции:
- sum() – сумма
- min() – минимум
- max() – максимум
- count() – количество временных рядов
- topk(n, ...) – топ n значений

```promql
topk(5, rate(http_requests_total[5m]))
```
Выведет топ-5 сервисов по количеству запросов.

## Работа со временем

```promql
http_requests_total offset 1h
```
Вернет значение метрики час назад.

```promql
rate(http_requests_total[5m]) - rate(http_requests_total[1h])
```
Разница между средней скоростью запросов за 5 минут и за час.

## Группировка данных

```promql
sum(rate(http_requests_total[5m])) by (status)
```
Посчитаем количество запросов, сгруппировав по HTTP-кодам.

## Разница между rate() и irate() в PromQL

Обе функции используются для расчета скорости изменения **счетчиков (Counter)**, но у них разные подходы:

### rate() — средняя скорость за интервал

Функция rate() вычисляет **среднюю** скорость изменения метрики за заданный временной интервал.
```promql
rate(http_requests_total[5m])
```
Это покажет **среднюю скорость** запросов за последние 5 минут.

- Подходит для анализа трендов.
- Используется в дашбордах и алертах.
- Хорош для данных с шумом (всплесками).

### irate() — мгновенная скорость

Функция irate() берет **только два последних значения** в заданном временном окне и рассчитывает скорость изменения между ними.
```promql
irate(http_requests_total[5m])
```
Это покажет **мгновенную скорость** запросов за последние 5 минут.

- Подходит для отображения **моментальных изменений**.
- Лучше для графиков с высокой частотой обновления.
- Может давать более шумные результаты.

### Пример разницы

Допустим, у нас есть метрика http_requests_total, и данные выглядят так (значения увеличиваются):

| **Время** | **Значение** http_requests_total |
| --------- | -------------------------------- |
| 12:00     | 1000                             |
| 12:01     | 1020                             |
| 12:02     | 1050                             |
| 12:03     | 1100                             |
| 12:04     | 1200                             |
- **rate(http_requests_total[5m])**
	- Возьмет все точки за 5 минут, усреднит разницу → (1200 - 1000) / 5 = **40 req/sec**
- **irate(http_requests_total[5m])**
	- Возьмет только последние две точки (1200 и 1100) → (1200 - 1100) / 1 = **100 req/sec**
