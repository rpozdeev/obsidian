---
tags:
  - promql
---

# PromQL ‚Äî –Ø–∑—ã–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Prometheus

## –¢–∏–ø—ã –º–µ—Ç—Ä–∏–∫ –≤ Prometheus

- **Counter (—Å—á–µ—Ç—á–∏–∫)** ‚Äì –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è, –Ω–∞–ø—Ä–∏–º–µ—Ä http_requests_total.
- **Gauge (–∏–∑–º–µ—Ä–∏—Ç–µ–ª—å)** ‚Äì –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –≤ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä memory_usage_bytes.
- **Histogram (–≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞)** ‚Äì —Å–æ–±–∏—Ä–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤ –±–∞–∫–∞—Ö (buckets), –Ω–∞–ø—Ä–∏–º–µ—Ä http_request_duration_seconds_bucket.
- **Summary (—Å–≤–æ–¥–∫–∞)** ‚Äì –ø–æ—Ö–æ–∂ –Ω–∞ Histogram, –Ω–æ –≤–∫–ª—é—á–∞–µ—Ç –∫–≤–∞–Ω—Ç–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.

## –ë–∞–∑–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ PromQL

```promql
http_requests_total
```
–í–µ—Ä–Ω–µ—Ç –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã —Å —ç—Ç–æ–π –º–µ—Ç—Ä–∏–∫–æ–π.

```promql
http_requests_total{job="nginx", status="200"}
```
–í—ã–±–µ—Ä–µ—Ç —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ (status="200") –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è nginx.

## –§—É–Ω–∫—Ü–∏–∏ –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ PromQL

### –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```promql
rate(http_requests_total[5m]) * 100
```
–≠—Ç–æ –∑–∞–ø—Ä–æ—Å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 5 –º–∏–Ω—É—Ç, —É–º–Ω–æ–∂–µ–Ω–Ω—ã–π –Ω–∞ 100.

### –ê–≥—Ä–µ–≥–∞—Ü–∏—è

```promql
avg(rate(http_requests_total[5m]))
```
–ü–æ—Å—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –≤—Å–µ–º –∏–Ω—Å—Ç–∞–Ω—Å–∞–º.

–î—Ä—É–≥–∏–µ –∞–≥—Ä–µ–≥–∏—Ä—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- sum() ‚Äì —Å—É–º–º–∞
- min() ‚Äì –º–∏–Ω–∏–º—É–º
- max() ‚Äì –º–∞–∫—Å–∏–º—É–º
- count() ‚Äì –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤
- topk(n, ...) ‚Äì —Ç–æ–ø n –∑–Ω–∞—á–µ–Ω–∏–π

```promql
topk(5, rate(http_requests_total[5m]))
```
–í—ã–≤–µ–¥–µ—Ç —Ç–æ–ø-5 —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤.

## –†–∞–±–æ—Ç–∞ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º

```promql
http_requests_total offset 1h
```
–í–µ—Ä–Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —á–∞—Å –Ω–∞–∑–∞–¥.

```promql
rate(http_requests_total[5m]) - rate(http_requests_total[1h])
```
–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Å—Ä–µ–¥–Ω–µ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 5 –º–∏–Ω—É—Ç –∏ –∑–∞ —á–∞—Å.

## –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```promql
sum(rate(http_requests_total[5m])) by (status)
```
–ü–æ—Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–≤ –ø–æ HTTP-–∫–æ–¥–∞–º.

## –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É rate() –∏ irate() –≤ PromQL

–û–±–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è **—Å—á–µ—Ç—á–∏–∫–æ–≤ (Counter)**, –Ω–æ —É –Ω–∏—Ö —Ä–∞–∑–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã:

### rate() ‚Äî —Å—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª

–§—É–Ω–∫—Ü–∏—è rate() –≤—ã—á–∏—Å–ª—è–µ—Ç **—Å—Ä–µ–¥–Ω—é—é** —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫–∏ –∑–∞ –∑–∞–¥–∞–Ω–Ω—ã–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª.
```promql
rate(http_requests_total[5m])
```
–≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç **—Å—Ä–µ–¥–Ω—é—é —Å–∫–æ—Ä–æ—Å—Ç—å** –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç.

- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –¥–∞—à–±–æ—Ä–¥–∞—Ö –∏ –∞–ª–µ—Ä—Ç–∞—Ö.
- –•–æ—Ä–æ—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö —Å —à—É–º–æ–º (–≤—Å–ø–ª–µ—Å–∫–∞–º–∏).

### irate() ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å

–§—É–Ω–∫—Ü–∏—è irate() –±–µ—Ä–µ—Ç **—Ç–æ–ª—å–∫–æ –¥–≤–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è** –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ–∫–Ω–µ –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ–∂–¥—É –Ω–∏–º–∏.
```promql
irate(http_requests_total[5m])
```
–≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç **–º–≥–Ω–æ–≤–µ–Ω–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å** –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç.

- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è **–º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π**.
- –õ—É—á—à–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –≤—ã—Å–æ–∫–æ–π —á–∞—Å—Ç–æ—Ç–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
- –ú–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –±–æ–ª–µ–µ —à—É–º–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

### –ü—Ä–∏–º–µ—Ä —Ä–∞–∑–Ω–∏—Ü—ã

–î–æ–ø—É—Å—Ç–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å –º–µ—Ç—Ä–∏–∫–∞ http_requests_total, –∏ –¥–∞–Ω–Ω—ã–µ –≤—ã–≥–ª—è–¥—è—Ç —Ç–∞–∫ (–∑–Ω–∞—á–µ–Ω–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è):

| **–í—Ä–µ–º—è** | **–ó–Ω–∞—á–µ–Ω–∏–µ** http_requests_total |
| --------- | -------------------------------- |
| 12:00     | 1000                             |
| 12:01     | 1020                             |
| 12:02     | 1050                             |
| 12:03     | 1100                             |
| 12:04     | 1200                             |
- **rate(http_requests_total[5m])**
	- –í–æ–∑—å–º–µ—Ç –≤—Å–µ —Ç–æ—á–∫–∏ –∑–∞ 5 –º–∏–Ω—É—Ç, —É—Å—Ä–µ–¥–Ω–∏—Ç —Ä–∞–∑–Ω–∏—Ü—É ‚Üí (1200 - 1000) / 5 = **40 req/sec**
- **irate(http_requests_total[5m])**
	- –í–æ–∑—å–º–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–≤–µ —Ç–æ—á–∫–∏ (1200 –∏ 1100) ‚Üí (1200 - 1100) / 1 = **100 req/sec**

### –ö–æ–≥–¥–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?

| **–§—É–Ω–∫—Ü–∏—è** | **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è**                       |
| ----------- | ------------------------------------------ |
| rate()      | –û–±—â–∞—è —Ç–µ–Ω–¥–µ–Ω—Ü–∏—è, –≥—Ä–∞—Ñ–∏–∫–∏, –∞–ª–µ—Ä—Ç—ã           |
| irate()     | –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –≤—Å–ø–ª–µ—Å–∫–∏, –¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ |
–ï—Å–ª–∏ —Å—Ç—Ä–æ–∏—à—å **–≥—Ä–∞—Ñ–∏–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π rate().
–ï—Å–ª–∏ —Ö–æ—á–µ—à—å **–ø–æ–π–º–∞—Ç—å —Ä–µ–∑–∫–∏–µ —Å–∫–∞—á–∫–∏** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π irate(). üöÄ